<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>הצעות עזרה זמינות</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<!-- 🔵 סרגל ניווט למשפחות -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold text-white" href="#">מערכת הסיוע - משפחות</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarNav" aria-controls="navbarNav"
                aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item"><a class="nav-link" href="/family/dashboard">דף הבית</a></li>
                <li class="nav-item"><a class="nav-link" href="/needs/new">בקשה חדשה</a></li>
                <li class="nav-item"><a class="nav-link active" href="/match/offers">רשימת מתנדבים</a></li>
                <li class="nav-item">
                    <a class="nav-link d-flex align-items-center gap-1" href="/family/matches">
                        התאמות ממתינות
                        <span class="badge bg-danger" th:text="${pendingMatchCount}" th:if="${pendingMatchCount > 0}">0</span>
                    </a>
                </li>                <li class="nav-item"><a class="nav-link" href="/chat/list">שיחות</a></li>
                <li class="nav-item"><a class="nav-link" href="/logout">התנתקות</a></li>
            </ul>
            <span class="navbar-text text-white">שלום, <span th:text="${user.fullName}">משתמש</span> 👋</span>
        </div>
    </div>
</nav>

<div class="container mt-5">

    <div class="text-center mb-4">
        <h2 class="fw-bold text-primary">הצעות עזרה שמתאימות לבקשות שלך</h2>
        <p class="text-muted">אם אין התאמות, תוכל להשתמש בסינון ידני כדי לראות הצעות נוספות</p>
    </div>

    <!-- טופס סינון -->
    <form method="get" th:action="@{/match/offers}" class="row g-3 mb-4">
        <div class="col-md-3">
            <label class="form-label">סוג עזרה</label>
            <select class="form-select" name="helpType">
                <option value="">הכל</option>
                <option th:each="type : ${helpTypes}"
                        th:value="${type.name()}"
                        th:text="${type.hebrew}"
                        th:selected="${type} == ${selectedHelpType}">
                </option>
            </select>
        </div>

        <div class="col-md-3">
            <label class="form-label">אזור</label>
            <select class="form-select" name="region">
                <option value="">הכל</option>
                <option th:each="r : ${regions}"
                        th:value="${r.name()}"
                        th:text="${r.hebrew}"
                        th:selected="${r} == ${selectedRegion}">
                </option>
            </select>
        </div>

        <div class="col-md-3">
            <label class="form-label">יום פנוי</label>
            <select class="form-select" name="day">
                <option value="">הכל</option>
                <option th:each="d : ${days}"
                        th:value="${d.name()}"
                        th:text="${d.hebrew}"
                        th:selected="${d} == ${selectedDay}">
                </option>
            </select>
        </div>

        <div class="col-md-3">
            <label class="form-label">שעת זמינות</label>
            <select class="form-select" name="time">
                <option value="">הכל</option>
                <option th:each="t : ${times}"
                        th:value="${t.name()}"
                        th:text="${t.hebrew}"
                        th:selected="${t} == ${selectedTime}">
                </option>
            </select>
        </div>

        <div class="col-12 d-flex justify-content-between align-items-center">
            <a th:href="@{/family/dashboard}" class="btn btn-secondary">⬅ חזרה לדשבורד</a>
            <a th:href="@{/match/offers(myMatches=true)}" class="btn btn-outline-success ms-2">🎯 התאמות לפי הבקשות שלי</a>
            <button type="submit" class="btn btn-primary">בצע סינון</button>
        </div>
    </form>

    <!-- תוצאות -->
    <div th:if="${#lists.isEmpty(offers)}" class="alert alert-info text-center">
        לא נמצאו הצעות תואמות לבקשות שלך.
    </div>

    <div th:if="${!#lists.isEmpty(offers)}" class="card shadow-sm">
        <div class="card-body">
            <h5 class="card-title mb-3">הצעות שנמצאו</h5>
            <div class="table-responsive">
                <table class="table table-striped text-center align-middle">
                    <thead class="table-dark">
                    <tr>
                        <th>סוג עזרה</th>
                        <th>אזור</th>
                        <th>יום</th>
                        <th>שעה</th>
                        <th>תיאור</th>
                        <th>יצירת קשר</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="offer : ${offers}" th:with="match=${existingMatches.get(offer.id)}">
                        <td th:text="${offer.helpType.hebrew}">עזרה</td>

                        <td>
                            <span th:each="r, stat : ${offer.regions}">
                                <span th:text="${r.hebrew}">אזור</span><span th:if="${!stat.last}">, </span>
                            </span>
                        </td>

                        <td>
                            <span th:each="d, stat : ${offer.daysAvailable}">
                                <span th:text="${d.hebrew}">יום</span><span th:if="${!stat.last}">, </span>
                            </span>
                        </td>

                        <td>
                            <span th:each="t, stat : ${offer.timeSlots}">
                                <span th:text="${t.hebrew}">שעה</span><span th:if="${!stat.last}">, </span>
                            </span>
                        </td>

                        <td th:text="${offer.description}">תיאור</td>

                        <td>
                            <div th:if="${match != null}">
                                <span class="text-success fw-bold">✅ נשלחה בקשת קשר בהצלחה</span><br/>
                                <a class="btn btn-outline-primary btn-sm mt-2"
                                   th:href="@{'/chat/' + ${chatThreadIds[match.id]}}">
                                    ⬅ מעבר לצ'אט
                                </a>
                            </div>

                            <div th:if="${match == null}">
                                <form th:action="@{/match/accept-direct}" method="post">
                                    <input type="hidden" name="offerId" th:value="${offer.id}" />
                                    <button type="submit" class="btn btn-primary btn-sm">שלח בקשה לעזרה</button>
                                </form>
                            </div>
                        </td>

                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

</body>
</html>
